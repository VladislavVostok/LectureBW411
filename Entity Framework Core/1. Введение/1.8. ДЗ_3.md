
## Тема: "Фитнес-трекер" - конфигурация, миграции и логирование

---

## **Цель задания**
Научиться настраивать Entity Framework Core в реальном проекте: правильно конфигурировать подключение к БД, создавать и управлять миграциями, настраивать логирование операций с базой данных.

## **Общее описание**
Вы разрабатываете систему для фитнес-центра. Нужно создать базу данных для учета клиентов, тренеров, упражнений и тренировок. Особое внимание уделите качественной настройке EF Core.

---

## **Часть 1: Подготовка проекта и конфигурация**

### **Задача 1.1: Настройка конфигурации приложения**
Создайте консольное приложение .NET и настройте систему конфигурации:

1. **Добавьте необходимые NuGet пакеты:**
   - Microsoft.EntityFrameworkCore.SqlServer
   - Microsoft.EntityFrameworkCore.Tools
   - Microsoft.Extensions.Configuration.Json
   - Microsoft.Extensions.Configuration.EnvironmentVariables

2. **Создайте файлы конфигурации:**
   - `appsettings.json` - основные настройки
   - `appsettings.Development.json` - настройки для разработки

3. **В `appsettings.json` определите:**
   - Строки подключения для основной и тестовой БД
   - Настройки БД (количество повторов при ошибке, таймауты)
   - Настройки логирования (уровни логирования, путь к файлам логов)
   - Настройки приложения (размер страницы, флаги)

4. **Реализуйте класс `AppConfiguration`**, который загружает настройки из:
   - Основного файла конфигурации
   - Файла конфигурации для текущего окружения
   - Переменных окружения
   - Аргументов командной строки

### **Пример структуры appsettings.json:**
```json
{
  "ConnectionStrings": {
    "FitnessTracker": "Server=localhost;Database=FitnessTracker;Trusted_Connection=True;"
  },
  "DatabaseSettings": {
    "MaxRetryCount": 3,
    "CommandTimeout": 30
  }
}
```

---

## **Часть 2: Создание моделей и их конфигурация**

### **Задача 2.1: Создайте 4 модели данных**
Создайте классы для таблиц БД:

1. **Client (Клиент)** - информация о клиентах фитнес-центра
2. **Trainer (Тренер)** - информация о тренерах
3. **Exercise (Упражнение)** - описание упражнений
4. **WorkoutSession (Тренировка)** - информация о проведенных тренировках

**Пример класса Client:**
```csharp
public class Client
{
    public int Id { get; set; }
    public string FullName { get; set; }
    public DateTime BirthDate { get; set; }
    public string MembershipType { get; set; }
    public DateTime RegistrationDate { get; set; }
}
```

### **Задача 2.2: Настройка моделей через Fluent API**
Для каждой модели создайте класс конфигурации, который реализует `IEntityTypeConfiguration<T>`.

**Что нужно настроить для каждой модели:**
1. Имя таблицы и схемы
2. Первичный ключ
3. Ограничения для строковых полей (максимальная длина, обязательность)
4. Индексы для часто используемых полей
5. Значения по умолчанию
6. Проверочные ограничения (CHECK constraints)

**Пример для Client:**
```csharp
public class ClientConfiguration : IEntityTypeConfiguration<Client>
{
    public void Configure(EntityTypeBuilder<Client> builder)
    {
        builder.ToTable("Clients", "fitness");
        builder.HasKey(c => c.Id);
        
        builder.Property(c => c.FullName)
            .IsRequired()
            .HasMaxLength(100);
            
        builder.Property(c => c.MembershipType)
            .HasMaxLength(20)
            .HasDefaultValue("Разовый");
    }
}
```

---

## **Часть 3: Работа с миграциями**

### **Задача 3.1: Создание и настройка миграций**
1. **Создайте начальную миграцию** с именем `InitialCreate`
   ```bash
   dotnet ef migrations add InitialCreate
   ```

2. **Просмотрите сгенерированный код миграции** и убедитесь, что все таблицы создаются корректно

3. **Примените миграцию** к базе данных:
   ```bash
   dotnet ef database update
   ```

### **Задача 3.2: Создание дополнительных миграций**
1. **Добавьте новое поле** `Email` в таблицу `Clients`
2. **Создайте миграцию** с именем `AddEmailToClients`
3. **Добавьте кастомный SQL** в миграцию:
   - Создайте представление (VIEW) для активных клиентов
   - Создайте функцию для расчета возраста клиента

**Пример кастомного SQL в миграции:**
```csharp
protected override void Up(MigrationBuilder migrationBuilder)
{
    // Автосгенерированный код EF Core...
    
    // Ваш кастомный SQL
    migrationBuilder.Sql(@"
        CREATE VIEW fitness.ActiveClients AS
        SELECT * FROM fitness.Clients 
        WHERE MembershipType IN ('Месячный', 'Годовой')
    ");
}
```

### **Задача 3.3: Управление миграциями**
1. **Создайте скрипт миграции** для передачи DBA:
   ```bash
   dotnet ef migrations script --output migration_script.sql
   ```

2. **Создайте скрипт отката** последней миграции

3. **Проверьте список примененных миграций:**
   ```bash
   dotnet ef migrations list
   ```

---

## **Часть 4: Настройка логирования**

### **Задача 4.1: Настройка встроенного логирования EF Core**
1. **Включите логирование SQL-запросов** в консоль:
   ```csharp
   optionsBuilder.LogTo(Console.WriteLine, 
       new[] { DbLoggerCategory.Database.Command.Name },
       LogLevel.Information);
   ```

2. **Настройте разные уровни логирования** для разных категорий:
   - Для команд БД: Information
   - Для изменений: Warning
   - Для ошибок: Error

### **Задача 4.2: Создание кастомного логгера**
1. **Реализуйте класс `FileLogger`**, который записывает логи в файл
2. **Настройте ротацию логов** - новый файл каждый день
3. **Добавьте форматирование** логов с временем, уровнем и категорией

**Пример формата лога:**
```
2024-01-15 14:30:25 [INFO] Microsoft.EntityFrameworkCore.Database.Command: Executing query: SELECT * FROM Clients
```

### **Задача 4.3: Создание перехватчика команд (Command Interceptor)**
1. **Создайте класс `TimingInterceptor`**, который наследуется от `DbCommandInterceptor`
2. **Логируйте время выполнения** каждого SQL-запроса
3. **Выводите предупреждение**, если запрос выполняется дольше 1 секунды
4. **Логируйте параметры запросов** (для отладки)

---

## **Часть 5: Настройка DbContext**

### **Задача 5.1: Создание и настройка FitnessContext**
1. **Создайте класс `FitnessContext`**, наследующий от `DbContext`
2. **Добавьте DbSet** для каждой модели
3. **Переопределите метод `OnConfiguring`** для настройки:
   - Подключения к БД из конфигурации
   - Повторных попыток при ошибках
   - Таймаута команд
   - Логирования

4. **Переопределите метод `OnModelCreating`** для:
   - Применения конфигураций моделей
   - Настройки глобальных фильтров (например, только активные записи)

### **Пример настройки DbContext:**
```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    if (!optionsBuilder.IsConfigured)
    {
        var connectionString = _configuration.GetConnectionString("FitnessTracker");
        
        optionsBuilder.UseSqlServer(connectionString, options =>
        {
            options.EnableRetryOnFailure(
                maxRetryCount: 3,
                maxRetryDelay: TimeSpan.FromSeconds(30));
            options.CommandTimeout(30);
        })
        .LogTo(Console.WriteLine, LogLevel.Information)
        .EnableSensitiveDataLogging()
        .EnableDetailedErrors();
    }
}
```

---

## **Часть 6: Интеграция и тестирование**

### **Задача 6.1: Создание фабрики DbContext**
1. **Реализуйте `FitnessDbContextFactory`** для создания экземпляров контекста
2. **Настройте Dependency Injection** для регистрации контекста и фабрики

### **Задача 6.2: Написание тестового приложения**
Создайте консольное приложение, которое:
1. **Применяет миграции** при запуске
2. **Заполняет базу тестовыми данными**
3. **Выполняет основные операции** (добавление, чтение, обновление, удаление)
4. **Логирует все операции** в файл и консоль
5. **Выводит статистику** по выполненным операциям

### **Пример тестового сценария:**
```csharp
// 1. Создать клиента
var client = new Client { FullName = "Иванов Иван", ... };
context.Clients.Add(client);
await context.SaveChangesAsync();
Console.WriteLine($"Создан клиент: {client.FullName}");

// 2. Прочитать всех клиентов
var clients = await context.Clients.ToListAsync();
Console.WriteLine($"Всего клиентов: {clients.Count}");

// 3. Проверить логи - должен быть записан SQL-запрос
```

---

## **Требования к выполнению**

### **Что нужно сдать:**
1. **Исходный код проекта** (архив или ссылка на репозиторий)
2. **Файлы миграций** (.cs файлы)
3. **SQL-скрипты** создания БД
4. **Примеры лог-файлов** с разными уровнями сообщений
5. **Инструкцию по запуску** проекта
6. **Скриншоты** работы приложения

---

## **Полезные команды для выполнения:**

```bash
# Создание миграции
dotnet ef migrations add НазваниеМиграции

# Применение миграций
dotnet ef database update

# Откат миграции
dotnet ef database update ПредыдущаяМиграция

# Создание скрипта миграции
dotnet ef migrations script --output script.sql

# Проверка состояния миграций
dotnet ef migrations list
```

---
