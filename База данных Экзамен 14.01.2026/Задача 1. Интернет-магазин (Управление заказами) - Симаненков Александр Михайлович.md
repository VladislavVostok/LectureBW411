
**Тема:** Торговля и учет остатков.

**1. Сущности и связи (Таблицы):**
- **Products** (Товары): `ProductID` (PK), `Name`, `Price`, `StockQuantity` (количество на складе).
- **Customers** (Клиенты): `CustomerID` (PK), `Name`, `Email`.
- **Orders** (Заказы): `OrderID` (PK), `CustomerID` (FK), `OrderDate`, `TotalAmount`.
- **OrderDetails** (Детали заказа): `OrderDetailID` (PK), `OrderID` (FK), `ProductID` (FK), `Quantity`.

**2. Триггер:**
- Создать триггер **AFTER INSERT** на таблицу `OrderDetails`. При добавлении товара в заказ триггер должен автоматически уменьшать значение `StockQuantity` в таблице `Products` на соответствующее количество. Если товара недостаточно, генерировать ошибку и отменять вставку.

**3. Пользовательская функция**:
- Создать скалярную функцию `fn_GetCustomerTotal(@CustomerID)`, которая возвращает общую сумму всех заказов указанного клиента.

**4. Хранимые процедуры:**
- `sp_CreateOrder`: Процедура для создания нового заказа. Принимает ID клиента и список товаров (можно упростить для одного товара для экзамена), создает запись в `Orders` и `OrderDetails`.

**5. Транзакция:**
- Внутри процедуры `sp_CreateOrder` реализовать транзакцию. Суть: запись заказа в таблицу `Orders` и добавление позиций в `OrderDetails` должны выполняться как единое целое. Если при добавлении позиции возникнет ошибка (например, триггер остановит операцию), необходимо выполнить откат (`ROLLBACK`) всей транзакции, чтобы не создавать "пустой" заказ.

