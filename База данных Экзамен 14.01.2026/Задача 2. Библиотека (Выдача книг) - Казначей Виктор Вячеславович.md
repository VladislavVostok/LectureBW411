**Тема:** Работа с временными данными и статусами.

**1. Сущности и связи (Таблицы):**

- **Books** (Книги): `BookID` (PK), `Title`, `Author`, `IsAvailable` (бит, доступна ли книга).
- **Readers** (Читатели): `ReaderID` (PK), `FullName`, `PhoneNumber`.
- **Loans** (Выдачи): `LoanID` (PK), `BookID` (FK), `ReaderID` (FK), `IssueDate`, `ReturnDate` (может быть NULL).

**2. Триггер:**

- Создать триггер **INSTEAD OF INSERT** на таблицу `Loans`. Перед вставкой новой записи триггер должен проверять поле `IsAvailable` в таблице `Books`. Если книга недоступна (`IsAvailable = 0`), вставка отменяется с сообщением об ошибке. Если доступна — запись добавляется, и флаг `IsAvailable` в таблице `Books` становится равным 0.

**3. Пользовательская функция:**

- Создать табличную функцию `fn_GetCurrentLoans(@ReaderID)`, которая возвращает таблицу всех книг, которые сейчас на руках у конкретного читателя (где `ReturnDate` равно NULL).

**4. Хранимые процедуры:**

- `sp_ReturnBook`: Процедура для возврата книги. Принимает `LoanID`. Обновляет поле `ReturnDate` текущей датой и должна пометить книгу как доступную.

**5. Транзакция:**

- В процедуре `sp_ReturnBook` использовать транзакцию. Необходимо одновременно обновить запись в таблице `Loans` (поставить дату возврата) и изменить статус `IsAvailable` на 1 в таблице `Books`. Если одно из обновлений не удается, откатить изменения.

### Замечания по решения:

 * Таблицы: Таблицы Books, Readers, Loans созданы правильно, типы данных и ключи соответствуют заданию.
   * Триггер: Триггер InsteadOfLoanInsert типа INSTEAD OF INSERT реализован образцово. Он корректно проверяет доступность книги, отменяет вставку с выводом ошибки, если книга занята, либо добавляет запись о выдаче и обновляет статус книги.
   * Функция: Функция fn_GetCurrentLoans написана верно. Она принимает ID читателя и возвращает список книг, которые у него на руках.
   * Хранимая процедура: Процедура sp_ReturnBook реализована отлично. Для управления транзакцией используется конструкция TRY...CATCH, что является лучшей практикой для обработки возможных ошибок при обновлении данных в нескольких таблицах.


  **Вывод**: Ученик продемонстрировал глубокое понимание темы, особенно в реализации сложного триггера и надежной
  транзакции.

  **Оценка**: 12/12