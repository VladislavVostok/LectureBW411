
#### Многопользовательская система

Linux, как и ее прародительница UNIX, является многозадачной многопользова­тельской операционной системой. Это означает, что в один момент с системой могут работать несколько пользователей и каждый пользователь может запустить несколько приложений. При этом вы можете зайти в систему локально, а кто-то - удаленно, используя один из протоколов удаленного доступа (telnet, ssh), или по FTP. Согласитесь, очень удобно. 

Предположим, что вы забыли распечатать очень важный документ, а возвращаться домой уже нет времени. Если ваш компьютер должным образом настроен и подключен к Интернету, вы можете получить к нему доступ (даже если компьютер выключен, достаточно позвонить домой и попросить кого-нибудь включить его, а к Интернету компьютер подключится автоматически), зайти в систему по ssh (или подключиться к графическому интерфейсу, если вы предпочитаете работать в графическом режиме) и скопировать нужный вам файл. И если кто-либо в момент вашего подключения уже работает на этом компьютере с системой, вы не помешаете друг другу.

#### Пользователь root 
##### Полномочия пользователя root 

Пользователь root обладает в системе максимальными полномочиями, и она пол­ностью подвластна этому пользователю, - любая его команда будет выполнена безоговорочно. 

Поэтому работать под именем пользователя root нужно с осторожностью. Всегда думайте над тем, что собираетесь сделать, - если вы дадите команду на удаление корневой файловой системы, система выполнит и ее. В отличие от пользователя root, пользователю, зарегистрировавшемуся под обычным именем, при попытке выполнить ту или иную команду система сообщит, что у него нет для этого полномочий.

Представим, что кто-то решил пошутить и выложил в Интернете (записал на диск или прислал по электронной почте - способ доставки не важен) вредоносную про­грамму. Если вы ее запустите от имени пользователя root, система может быть по­вреждена. Запуск этой же программы от имени обычного пользователя ничего страшного не произведет - система откажется ее выполнять. Впрочем, все может быть намного проще: вы сами ошибочно введете команду, способную разрушить систему, или отойдете ненадолго от своего компьютера, а появившийся тут как тут некий «доброжелатель», имея полномочия пользователя root, сможет уничтожить систему одной командой.

Отсюда можно сделать следующие выводы: 
- если программа, полученная из постороннего источника, требует rооt-полномочий, это должно насторожить; 
- старайтесь реже работать пользователем root; 
- всегда думайте, какие программы вы запускаете под именем root
- создайте обычного пользователя (даже если вы сами являетесь единственным пользователем компьютера) и рутинные операции (с документами, использование Интернета и т. Д.) производите от имени этого пользователя;
- если полномочия root все же нужны, совсем необязательно заходить в систему  под этим пользователем достаточно запустить терминал и выполнить команду `sudo` или `su` , после чего в этом терминале можно будет выполнять команды с правами root. A закрыв терминал, вы потеряете права root,что весьма удобно, ведь обычно такие права требуются для одной-двух операций (например, выполнить команду установки программы или создать/удалить пользователя).

### Временное получение полномочий root  
Некоторые операции, например установка программного обеспечения, изменение  
конфигурационных файлов и т. п., требуют полномочий root. Чтобы их временно  
получить, следует использовать команды sudo или su (эти команды, скорее всего,  
вы будете запускать в терминале).  

#### Команда sudo  
Команда **sudo** позволяет запустить любую команду с привилегиями **root**. Использовать ее нужно так:  

```sh
sudo <команда которую нужно выполнить c правами root>
```

Например, вам необходимо изменить файл `/etc/apt/sources.list`. Для этого служит 
команда: 

```sh
sudo nano /etc/apt/sources.list 
```

```
ТЕКСТОВЫЙ РЕДАКТОР NANO 
Программа nano - это текстовый редактор, ему мы передаем один параметр - имя
файла, который нужно открыть. 
```

Если ввести эту же команду, но без **sudo** (просто: nano  /etc/apt/sources. list), тек­стовый редактор тоже запустится и откроет файл, но сохранить изменения в нем вы не сможете, поскольку у вас не хватит полномочий. 


Перед выполнением указанной вами команды команда запросит у вас пароль: 

```sh
sudo nano /etc/apt/sources.list 
Password: 
```

Вы должны ввести свой пользовательский пароль тот, который применяете  для вхо­да
в систему, но не пароль пользователя **root** мы его и не знаем). 


**ФАЙЛ /ETС/SUDOERS** 
Использовать команду sudo имеют право (кстати, не все пользователи, а только те, 
которые внесены в файл **/etc/sudoers**. Администратор системы (пользователь **root**) может редактировать этот файл с помощью команды **visudo**. Если на компьютере установлен дистрибутив, в котором запрещен вход под учетной записью root (следовательно, у вас нет возможности отредактировать файл sudoers}, то в файле sudoers содержатся пользова­тели, которых вы добавили при установке системы.

#### Команда su 
Команда **su** позволяет получить доступ к консоли с правами root любому пользова­телю (даже если пользователь не внесен в файл /etc/sudoers) при условии, что он знает пароль **root**. Понятно, что в большинстве случаев этим пользователем будет 
сам пользователь **root**,  - не станете же вы всем пользователям доверять свой 
пароль? Поэтому команда **su** предназначена в первую очередь для администратора 
системы, а sudo - **для** остальных пользователей, которым иногда нужны права **root** 
(чтобы они меньше отвлекали администратора от своей работы). 
Использовать команду su просто: 

```sh
su
```

После этого нужно будет ввести пароль пользователя **root**, и вы сможете работать 
в консоли как обычно. Использовать **su** удобнее, чем **sudo**, потому что вам не по­
требуется вводить **su** перед каждой командой, которая должна быть выполнена 
с правами **root**. 

Чтобы закрыть сессию su, нужно или ввести команду **exit**, или просто закрыть 
окно терминала.

#### Ввод серии команд sudo

Если надоело каждый раз вводить **sudo** в начале команды, тогда выполните команду:

```sh
sudo -i
```

Эта команда запустит оболочку **root** вы сможете вводить любые команды, и они будут выполнены с правами **root**. Обратите внимание, как изменился вид  приглашения командной строки: до этого приглашение имело вид **$** это означало, что вы работаете от имени обычного пользователя, a после выполнения команды **sudo -i** приглашение изменилось на **#** это верный признак того, что каждая введенная команда будет выполнена с правами **root**.

Опция **-i** позволяет так же удобно вводить команды, как если бы вы использовали  
команду **su**.


Аналогом команды **sudo -i** будет команда:

```sh
sudo bash
```

### Создание, удаление и модификация пользователей и групп стандартными средствами 

#### Отдельные пользователи  

Для добавления нового пользователя выполните следующие команды (от имени  
root): 

```sh
adduser <имя пользователя>  
passwd <имя пользователя>
```

Первая команда (**adduser**) добавляет пользователя, а вторая (**passwd**) изменяет его  
пароль. Ясно, что и в первом, и во втором случае вы должны указать одно и то же  
**имя пользователя**.  

В некоторых дистрибутивах например, в Ubuntu и Debian сценарий adduser не  
только добавляет пользователя, но и позволяет указать дополнительную информацию о пользователе и сразу же задать пароль пользователя.

**СЦЕНАРИИ ADDUSER и USERADD**  
в некоторых дистрибутивах (например, в openSUSE) вместо команды **adduser** используется команда **useradd**. Сценарии **adduser** и **useradd** обычно находятся в каталоге **/usr/sbin**

**КОМАНДА PASSWD** 
Команду **passwd** может использовать не только администратор, но и сам пользователь для изменения собственного пароля.

Для удаления пользователя служит команда **userdel**: 

```sh
userdel <имя пользователя> 
```

Давайте разберемся, что же происходит при создании новой учетной записи поль­зователя. 
**Во-первых**, создается запись в файле /etc/passwd. Формат записи следующий: 

```txt
имя_пользователя:пароль:UID:GID:полное_имя:домашний_каталог:оболочка 
```

///////   Вставить картинку.

- **первое поле** - это логин пользователя, который он вводит для регистрации в системе. Пароль в современных системах в этом файле не указывается, и **вто­рое поле** осталось просто для совместимости со старыми системами. Пароли хранятся в файле /etc/shadow, о котором мы поговорим чуть позже; 
- **третье** и **четвертое поля**: UID (User ID) и GID (Group ID) - идентификаторы пользователя и группы соответственно. Идентификатор пользователя root всегда равен 0, как и идентификатор группы **root**. Список групп вы найдете в файле /etc/groups; 
- **пятое поле**- это настоящее имя пользователя. Оно может быть не заполнено, а может содержать фамилию, имя и отчество пользователя - всё зависит от педантичности администратора системы, т. е. от вас. 
- **шестое поле** содержит имя домашнего каталога. Обычно это каталог /home/<имя_пользователя>; 
- **последнее поле** - это имя командного интерпретатора, который будет обрабатывать введенные вами команды, когда вы зарегистрируетесь в консоли.

В целях повышения безопасности пароли в свое время были перенесены из файла /etc/passwd в файл /etc/shadow (доступен для чтения/записи только пользователю 
root), где они и хранятся в закодированном виде (используются алгоритмы MD5
или Blowfish - в некоторых системах). Узнать, с помощью какого алгоритма 
зашифрован пароль, очень просто: посмотрите на шифр - если он достаточно короткий и не начинается с символа $, то применен алгоритм DES ( самый слабый и 
ненадежный - он, как правило, используется в старых дистрибутивах). Если же 
шифр начинается с символов `$1$`, то это MD5, а если в начале шифра имеются сим­волы `$2а$`, то это Blowfish. 

Во-вторых, при создании пользователя создается каталог /hоmе/<имя пользователя>, 
в который копируется содержимое каталога /etc/skel. Каталог /etc/skel содержит 
«джентльменский набор» - файлы конфигурации по умолчанию, которые должны быть в любом пользовательском каталоге. Название каталога skel (от skeleton) полностью оправдывает себя - он действительно содержит «скелет» домашнего 
каталога пользователя. 


**РЕДАКТИРОВАНИЕ ФАЙЛА /ETС/SUDOERS**
Файл letclpasswd можно редактировать с помощью обычного текстового редактора. То 
есть вы можете очень легко, не прибегая к помощи ни графического конфиrуратора, 
ни команды useпnod, изменить параметры учетной записи любого пользователя -
например, задать для него друrую оболочку или прописать его настоящую фамилию. 
Однако при изменении домашнего каталога пользователя нужно быть осторожным! 
Если вы это сделали, то, чтобы у пользователя не возникло проблем с правами дос­тупа к новому каталоrу, следует выполнить команду: 

```sh
chown  -R <пользователь> <каталог>
```

### Группы пользователей 

Иногда пользователей объединяют в группы. Группы позволяют более эффективно управлять правами пользователей. Пусть над каким-либо проектом у вас должны совместно работать три разных пользователя - их достаточно объединить в одну группу, и тогда они получат доступ к домашним каталогам друг друга (по умол­чанию пользователи не имеют доступа к домашним каталогам других пользовате­лей, поскольку считается, что они находятся в разных группах).

Создать группу, а также поместить пользователя в группу позволяют графические 
конфигураторы. Вы можете использовать их - они очень удобные, но если вы 
хотите стать настоящим линуксоидом, то должны знать, что доступные в системе группы указываются в файле /etc/group. Добавить новую группу в систему можно с помощью команды **groupadd**, но, как правило, проще в текстовом редакторе добавить еще одну запись в файл **/etc/group**, а изменить группу пользователя еще лег­че - для этого достаточно отредактировать файл **/etc/passwd**. 


### Квотирование
Квотирование - это механизм ограничения дискового пространства пользователей Linux система многопользовательская, поэтому без ограничения дискового пространства здесь не обойтись. Когда вы используете компьютер в гордом одиночестве, то все дисковое пространство доступно вам и только вам, a вот когда пользователей несколько, нужно ограничить доступное пространство, чтобы один из  
пользователей не «узурпировал» все место на диске. Как именно вы будете ограничивать дисковое пространство, решать только вам  - можно поделить дисковое  
пространство поровну между пользователями, можно одним пользователям отдать  
больше места, a другим - меньше.

На домашнем компьютере квотирование вряд ли понадобится, a на сервере, как правило, для каталога /home отводится отдельный раздел жесткого диска. Поэтому будем считать, что y нас есть отдельный раздел, который монтируется к каталогу **/home**. 

Для настройки квот нужно установить пакет **quota** Больше ничего устанавливать не потребуется. 

Чтобы пользователи не потеряли свои данные, перезагрузитесь в однопользовательский режим (параметр ядра single). 


### Из работающей системы

Если у вас есть доступ к терминалу, можно перезагрузиться напрямую в single-user mode:

```sh
sudo systemctl rescue
```

или

```sh
sudo init 1
```

(в системах без `systemd`).

---

### **Важно:**

- В однопользовательском режиме загружается минимальный набор служб.
- Сетевые службы обычно отключены (если не указан `network` в параметрах).
- Для выхода из single-user mode выполните:

```
exit
```
или   
```
systemctl default
```

или просто перезагрузитесь.

**Теперь можно приступать к редактированию квот.** 

**Первым** делом разрешим устанавливать квоты на разделе, который содержит файлы пользователей. Откройте файл **/etc/fstab**: 

```sh
nano /etc/fstab
``` 

Добавьте параметр **usrquota** к списку параметров раздела: 

```txt
/dev/sda5 /home ext4    defaults,usrquota 0 2 
```

Параметр **usrquota** включает поддержку квот для отдельных пользователей. Если вам нужна поддержка квот групп пользователей, тогда добавьте параметр **grpquota**. 

Теперь перемонтируем **/home**, поскольку мы только что изменили его параметры: 

```sh
mount -o remount /home
``` 

Механизм квотирования требует создания файлов **aquota.user** и **aquota.group**, но поскольку мы будем устанавливать квоты только для пользователей, a не для групп, то и создадим лишь файл **aquota.user**: 

```sh
touch /home aquota.user 
chmod 600 /home aquota.user 
```

После этого введем команду: 

```sh
quotacheck -vagum
``` 

Раз мы создали файл aquota user вручную, то получим сообщение об ошибке, но это только в первый раз далее все будет нормально.

Теперь отредактируем квоты для пользователя user: 

```sh
edquota -u user
``` 

Будет запущен текстовый редактор по умолчанию, и вы увидите следующий текст: 

/// Вставить картинку


УСТАНОВКА РЕДАКТОРА ПО УМОЛЧАНИЮ 
По умолчанию используется редактор vi, который, мягко говоря, не слишком удобен. Для изменения редактора по умолчанию установите переменную окружения EDITOR. 
Например: EDITOR=nano.

```
export EDITOR=nano
```

Разберемся, что это значит: 
- **blocks** - место в блоках, используемое пользователем (1 блок= 1 Кбайт); 
- **soft** - максимальное дисковое пространство (в блоках по 1 Кбайт), которое может занимать пользователь. Если вы включите период отсрочки (grace period), то пользователь получит только лишь сообщение о превышении квоты; 
- **hard** - жесткое ограничение, эту квоту пользователь превысить не может, даже если включен период отсрочки. Предположим, вы хотите «отдать» пользо­ вателю 500 Мбайт. В качестве жесткой квоты можно установить значение 500 Мбайт (или 500_000  блоков), а в качестве «мягкой» - значение 495 Мбайт (495_000 блоков). Когда пользователь превысит 495 Мбайт, он получит сообщение о превышении квоты, а вот когда будет превышена жесткая квота, то пользователь больше не сможет сохранять файлы в своем домашнем каталоге; 
- **inodes** - число используемых пользователем файлов.


Оrредактируйте квоты так: 

Disk  quotas  for user user  (uid 1001): 
Filesystem     blocks      soft        hard        inodes      soft    hard
/dev/sda5     16             95000    500000   5               0        0

Теперь сохраните файл, выйдите из редактора и введите команду: 

```sh
edquota -t
```

Вы должны вместо 7days вписать свой период отсрочки, при этом используйте названия единиц изменения времени на английском: 

- **seconds** - секунды; 
- **minutes** - минуты;         
- **hours** - часы; 
- **dауs** - дни; 
- **weeks** - недели; 
- **months** - месяцы. 

**Например:** 
- **24hours** - 24 часа; 
- **2days** - 2 дня; 
- **1weeks** - 1 неделя.

Включим квотирование для наших файловых систем: 

```sh
quotaon файловая система 
```

Например: 

```sh
quotaon /
```

После этого перезагрузим систему: 

```sh
reboot
``` 

При загрузке вы увидите сообщение: **Turning on user and group quotas for local filesystems** (Включаем квоты пользователей и групп для локальных файловых систем) - это означает что механизм квотирования работает правильно. 

Для просмотра квот служит команда **repquota**, например: 

```sh
repquota /home 
```

Наверняка так устанавливать квоты для каждого пользователя в отдельности, особенно если их много, вам покажется неудобным. Значительно упрощают задание квот так называемые **прототипы**. Например, вы задали ограничение для пользователя **user_name**, но y вас есть еще несколько пользователей, для которых нужно задать такие же ограничения. Вы можете использовать квоту пользователя **user_name** в качестве прототипа: 

```sh
edquota p **user_name** user1 
edquota -р **user_name** user2 
```